<!DOCTYPE html>
<html>
	<head>
		<meta charset=utf-8>
		<title>&#65279;</title>
		<link rel="shortcut icon" type="image/x-icon" href="icons/yuen.png" />
		<link href="https://fonts.googleapis.com/css?family=Rubik" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="css/style.css">
	</head>
	<body>
		<div>
			<img id="title" src="icons/title.png"/>
		</div>
		<div id="searchBarDiv">
			<div id="inputWrapper">
				<input id="searchBar" type="input" placeholder="search for a song..."></input>
			</div>
			<div id="mountPoint"></div>
			<div class="spinner" id="spinner">
			  <div class="rect1"></div>
			  <div class="rect2"></div>
			  <div class="rect3"></div>
			  <div class="rect4"></div>
			  <div class="rect5"></div>
			</div>
		</div>
		<script src="js/three.js"></script>
		<script src="js/TrackballControls.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<script>
			// set up scene, camera, renderer
			var scene = new THREE.Scene();
			scene.background = new THREE.Color(0x000000);
			var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
			var renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			document.body.appendChild(renderer.domElement);

			// controls setup (for scrolling)
			var controls = new THREE.TrackballControls(camera, renderer.domElement);

			// adjust camera position
			camera.position.z = 150;
			camera.position.y = 30;

			// create particle wave
			var waveGeometry = new THREE.Geometry();
			var SEPARATION = 4;
			var AMOUNTX = 96;
			var AMOUNTZ = 96;
			for (var i = 0; i < AMOUNTX; i++) {
				for (var j = 0; j < AMOUNTZ; j++) {
					var particle = new THREE.Vector3();
					particle.x = i*SEPARATION-((100*SEPARATION)/2);
					particle.y = 0;
					particle.z = j*SEPARATION-((100*SEPARATION)/2);
					waveGeometry.vertices.push(particle);
				}
			}
			var particleMaterial = new THREE.PointsMaterial({color: 0xffffff, size: .5});
			var wave = new THREE.Points(waveGeometry, particleMaterial);
			scene.add(wave);

			// animate the particle wave (default wave motion)
			var count = 0;
			function animateWave(amp) {
				var index = 0;
				for (var i = 0; i < AMOUNTX; i++) {
					for (var j = 0; j < AMOUNTZ; j++) {
						var current = waveGeometry.vertices[index++];
						current.y = (Math.sin((i+count)*0.3)*amp)+(Math.sin((j+count)*0.5)*amp);
						waveGeometry.verticesNeedUpdate = true;
					}
				}
				count += 0.080;
			}

			// audio setup:
			var context = new AudioContext();
			var analyser = context.createAnalyser();
			analyser.fftSize = 32;
			var source, frequencyData;
			function loadSound(vidID) {
				var request = new XMLHttpRequest();
				request.open("GET", window.location.href+"stream/"+vidID, true); 
				request.responseType = "arraybuffer"; 
				request.onload = function() {
					var Data = request.response;
					process(Data);
				};
				request.send();
			}
			function process(Data) {
				source = context.createBufferSource();
				context.decodeAudioData(Data, function(buffer){
					source.buffer = buffer;
					source.connect(context.destination);
					source.connect(analyser);
					source.start(context.currentTime);
				});
				loading(true);
			}
			var freqDataArr = new Uint8Array(analyser.frequencyBinCount);

			// search bar processing
			function buildURL(inputString) {
				const reqURL = 'https://www.googleapis.com/youtube/v3/search?';
				const key = 'AIzaSyDxh3kaGDIm8HagG7MGCchvcY5jLpDSHoM';
				let resURL = reqURL + 'part=snippet&maxResults=5&order=relevance&';
				resURL += 'q='+encodeURIComponent(inputString+' lyric video').replace(/%20/g, "+");
				resURL += '&type=video&key=' + key;
				return (resURL);
			}
			function loading(loadedAudio) {
				var x = document.getElementById('spinner');
				if (loadedAudio) {
					x.style.display = 'none';
				} else {
					x.style.display = 'block';
				}
			}
			function clearSearch() {
				while (mountDiv.firstChild) {
				    mountDiv.removeChild(mountDiv.firstChild);
				}
			}
			var mountDiv = document.getElementById('mountPoint');
			$('#searchBar').keyup(function(e) {
				const inputRaw = document.querySelector('#searchBar').value;
				const inputString = String(inputRaw);
				if (e.which === 8) {
					return (false);
				}
				if (e.which === 13) {
					while (mountDiv.firstChild) {
					    mountDiv.removeChild(mountDiv.firstChild);
					}
					fetch(buildURL(inputString), {
						method: 'GET',
					})
					.then(response => response.json())
					.then(json => {
						if (json.items.length > 0) {
							let i = 0;
							while (i < 5) {
								const vidID = json.items[i].id.videoId;
								const title = json.items[i].snippet.title;
								mountDiv = document.getElementById('mountPoint');
								var searchDiv = document.createElement('li');
								searchDiv.setAttribute('class', 'dropElement');
								searchDiv.innerHTML = title;
								searchDiv.addEventListener('click', function() {
									loading(false);
									loadSound(vidID);
									$('#searchBar').val(title);
									clearSearch();
								});
								mountDiv.appendChild(searchDiv);
								i++;
							};
						}
					});
				}
			});
			$('#searchBar').focus(function(e) {
			    $('#searchBar').val('');
			});
			$('canvas, #searchBarDiv, #title').click(function(e) {
				if (mountDiv.firstChild) {
					$('#searchBar').val('');
					clearSearch();
				}
			});
			
			var amplitude = 2;
			function scaleBetween(unscaledNum, minAllowed, maxAllowed, min, max) {
				return (maxAllowed-minAllowed)*(unscaledNum-min)/(max-min)+minAllowed;
			}
			function getBass() {
				analyser.getByteFrequencyData(freqDataArr);
				var frequencyData = freqDataArr;
				var volume = 0;
				for (var i = 0; i < frequencyData.length/2; i++) {
					volume += frequencyData[i];
				}
				volume = volume/(frequencyData.length/2);
				return (volume);
			}
			function getTreble() {
				analyser.getByteFrequencyData(freqDataArr);
				var frequencyData = freqDataArr;
				var volume = 0;
				for (var i = frequencyData.length/2; i < frequencyData.length; i++) {
					volume += frequencyData[i];
				}
				volume = volume/(frequencyData.length/2);
				return (volume);
			}
			function scalePoints(value) {
				wave.material.size = value;
			}
			function audioUpdate() {
				var bass = scaleBetween(getBass(), 2, 20, 0, 255);
				var treble = (scaleBetween(getTreble(), .5, 3, 0, 255));
				scalePoints(treble);
				animateWave(bass);
			}

			// animate loop
			var animate = function () {
				controls.update();
				requestAnimationFrame(animate);
				renderer.render(scene, camera);
				audioUpdate();
			};

			animate();

		</script>
	</body>
</html>